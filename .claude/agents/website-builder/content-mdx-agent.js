#!/usr/bin/env node

/**
 * Content MDX Agent - Blog & Content System Builder
 *
 * Responsibilities:
 * - Set up MDX blog infrastructure (next-mdx-remote, gray-matter)
 * - Create blog post templates and layouts
 * - Generate content utilities (reading time, frontmatter parsing, etc.)
 * - Build markdown processing pipeline (remark-gfm, rehype-highlight)
 * - Create blog listing pages with pagination
 * - Generate RSS/Atom feeds
 * - Set up content search and filtering
 * - Create dynamic blog routes
 *
 * Usage:
 *   node content-mdx-agent.js --task-id <uuid> --execute
 *   node content-mdx-agent.js --project-id <uuid> --setup-blog
 */

const BASE_URL = process.env.MCP_URL || 'https://dashboard.advancingtechnology.online/api/mcp';
const API_KEY = process.env.MCP_API_KEY || 'pd_HRLYeHmVbBoO0Q6gS7a9Q37s2jMle88y';

// ============================================================================
// MCP API HELPERS
// ============================================================================

async function mcpRequest(method, params = {}) {
  const requestId = `content-${Date.now()}-${Math.random().toString(36).substring(7)}`;

  try {
    const response = await fetch(BASE_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_KEY}`,
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id: requestId,
        method,
        params,
      }),
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    if (data.error) {
      throw new Error(`MCP Error: ${data.error.message || JSON.stringify(data.error)}`);
    }

    return data.result || data;
  } catch (error) {
    console.error(`[Content MDX Agent] MCP Request Failed (${method}):`, error.message);
    throw error;
  }
}

async function logAnalytics(eventType, eventData, projectId = null, executionTimeMs = null) {
  try {
    await mcpRequest('logBuilderAnalytics', {
      website_project_id: projectId,
      event_type: eventType,
      event_category: 'agent',
      event_data: eventData,
      agent_name: 'content',
      agent_execution_time_ms: executionTimeMs,
    });
  } catch (error) {
    console.error('[Content MDX Agent] Analytics logging failed:', error.message);
  }
}

// ============================================================================
// MDX SYSTEM CODE GENERATION
// ============================================================================

function generateMDXUtilities() {
  return `// MDX Utilities - Generated by Content MDX Agent
import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';

const POSTS_DIRECTORY = path.join(process.cwd(), 'content/posts');

export interface PostMetadata {
  slug: string;
  title: string;
  description?: string;
  date: string;
  author?: string;
  tags?: string[];
  image?: string;
  published?: boolean;
  readingTime?: number;
}

export interface Post extends PostMetadata {
  content: string;
}

/**
 * Get all post slugs from the content directory
 */
export function getPostSlugs(): string[] {
  if (!fs.existsSync(POSTS_DIRECTORY)) {
    return [];
  }

  return fs
    .readdirSync(POSTS_DIRECTORY)
    .filter((file) => file.endsWith('.mdx') || file.endsWith('.md'));
}

/**
 * Calculate reading time (words per minute)
 */
function calculateReadingTime(content: string, wpm = 200): number {
  const words = content.trim().split(/\\s+/).length;
  return Math.ceil(words / wpm);
}

/**
 * Get post data by slug
 */
export function getPostBySlug(slug: string): Post {
  const realSlug = slug.replace(/\\.mdx?$/, '');
  const fullPath = path.join(POSTS_DIRECTORY, \`\${realSlug}.mdx\`);

  if (!fs.existsSync(fullPath)) {
    // Try .md extension
    const mdPath = path.join(POSTS_DIRECTORY, \`\${realSlug}.md\`);
    if (!fs.existsSync(mdPath)) {
      throw new Error(\`Post not found: \${slug}\`);
    }
  }

  const fileContents = fs.readFileSync(
    fs.existsSync(fullPath) ? fullPath : path.join(POSTS_DIRECTORY, \`\${realSlug}.md\`),
    'utf8'
  );

  const { data, content } = matter(fileContents);

  return {
    slug: realSlug,
    title: data.title || 'Untitled',
    description: data.description,
    date: data.date || new Date().toISOString(),
    author: data.author,
    tags: data.tags || [],
    image: data.image,
    published: data.published !== false,
    readingTime: calculateReadingTime(content),
    content,
  };
}

/**
 * Get all posts sorted by date (newest first)
 */
export function getAllPosts(): Post[] {
  const slugs = getPostSlugs();

  const posts = slugs
    .map((slug) => {
      try {
        return getPostBySlug(slug);
      } catch (error) {
        console.error(\`Error loading post \${slug}:\`, error);
        return null;
      }
    })
    .filter((post): post is Post => post !== null)
    .filter((post) => post.published)
    .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

  return posts;
}

/**
 * Get posts by tag
 */
export function getPostsByTag(tag: string): Post[] {
  const allPosts = getAllPosts();
  return allPosts.filter((post) => post.tags?.includes(tag));
}

/**
 * Get all unique tags
 */
export function getAllTags(): string[] {
  const allPosts = getAllPosts();
  const tags = new Set<string>();

  allPosts.forEach((post) => {
    post.tags?.forEach((tag) => tags.add(tag));
  });

  return Array.from(tags).sort();
}

/**
 * Get paginated posts
 */
export function getPaginatedPosts(
  page: number = 1,
  pageSize: number = 10
): { posts: Post[]; totalPages: number; currentPage: number } {
  const allPosts = getAllPosts();
  const totalPages = Math.ceil(allPosts.length / pageSize);
  const startIndex = (page - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const posts = allPosts.slice(startIndex, endIndex);

  return {
    posts,
    totalPages,
    currentPage: page,
  };
}
`;
}

function generateBlogPostPage() {
  return `// Blog Post Page - Generated by Content MDX Agent
import { notFound } from 'next/navigation';
import { MDXRemote } from 'next-mdx-remote/rsc';
import { getPostBySlug, getAllPosts } from '@/lib/mdx';
import remarkGfm from 'remark-gfm';
import rehypeHighlight from 'rehype-highlight';

interface PostPageProps {
  params: { slug: string };
}

export async function generateStaticParams() {
  const posts = getAllPosts();
  return posts.map((post) => ({ slug: post.slug }));
}

export async function generateMetadata({ params }: PostPageProps) {
  try {
    const post = getPostBySlug(params.slug);

    return {
      title: post.title,
      description: post.description,
      openGraph: {
        title: post.title,
        description: post.description,
        type: 'article',
        publishedTime: post.date,
        authors: post.author ? [post.author] : undefined,
        tags: post.tags,
        images: post.image ? [post.image] : undefined,
      },
    };
  } catch (error) {
    return {
      title: 'Post Not Found',
    };
  }
}

export default function PostPage({ params }: PostPageProps) {
  let post;

  try {
    post = getPostBySlug(params.slug);
  } catch (error) {
    notFound();
  }

  return (
    <article className="max-w-4xl mx-auto px-4 py-12">
      {/* Header */}
      <header className="mb-8">
        <h1 className="text-4xl md:text-5xl font-bold mb-4">{post.title}</h1>

        <div className="flex items-center gap-4 text-sm text-foreground-secondary">
          <time dateTime={post.date}>
            {new Date(post.date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}
          </time>

          {post.author && <span>by {post.author}</span>}

          {post.readingTime && <span>{post.readingTime} min read</span>}
        </div>

        {post.tags && post.tags.length > 0 && (
          <div className="flex gap-2 mt-4">
            {post.tags.map((tag) => (
              <span
                key={tag}
                className="px-3 py-1 text-xs bg-accent-primary/10 text-accent-primary rounded-full"
              >
                {tag}
              </span>
            ))}
          </div>
        )}
      </header>

      {/* Featured Image */}
      {post.image && (
        <div className="mb-8 rounded-xl overflow-hidden">
          <img
            src={post.image}
            alt={post.title}
            className="w-full h-auto"
          />
        </div>
      )}

      {/* Content */}
      <div className="prose prose-lg prose-invert max-w-none">
        <MDXRemote
          source={post.content}
          options={{
            mdxOptions: {
              remarkPlugins: [remarkGfm],
              rehypePlugins: [rehypeHighlight],
            },
          }}
        />
      </div>
    </article>
  );
}
`;
}

function generateBlogListingPage() {
  return `// Blog Listing Page - Generated by Content MDX Agent
import Link from 'next/link';
import { getAllPosts } from '@/lib/mdx';

export const metadata = {
  title: 'Blog',
  description: 'Articles, tutorials, and thoughts',
};

export default function BlogPage() {
  const posts = getAllPosts();

  return (
    <div className="max-w-4xl mx-auto px-4 py-12">
      <header className="mb-12">
        <h1 className="text-4xl md:text-5xl font-bold mb-4">Blog</h1>
        <p className="text-lg text-foreground-secondary">
          Articles, tutorials, and thoughts on web development, design, and more.
        </p>
      </header>

      <div className="space-y-8">
        {posts.map((post) => (
          <article key={post.slug} className="group">
            <Link href={\`/blog/\${post.slug}\`}>
              <div className="glass-card hover:glass-glow transition-all">
                {post.image && (
                  <div className="mb-4 rounded-lg overflow-hidden">
                    <img
                      src={post.image}
                      alt={post.title}
                      className="w-full h-48 object-cover group-hover:scale-105 transition-transform"
                    />
                  </div>
                )}

                <h2 className="text-2xl font-bold mb-2 group-hover:text-accent-primary transition-colors">
                  {post.title}
                </h2>

                {post.description && (
                  <p className="text-foreground-secondary mb-4">
                    {post.description}
                  </p>
                )}

                <div className="flex items-center gap-4 text-sm text-foreground-muted">
                  <time dateTime={post.date}>
                    {new Date(post.date).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                    })}
                  </time>

                  {post.readingTime && (
                    <span>{post.readingTime} min read</span>
                  )}

                  {post.tags && post.tags.length > 0 && (
                    <div className="flex gap-2">
                      {post.tags.slice(0, 3).map((tag) => (
                        <span
                          key={tag}
                          className="px-2 py-1 text-xs bg-accent-primary/10 text-accent-primary rounded"
                        >
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </Link>
          </article>
        ))}

        {posts.length === 0 && (
          <p className="text-center text-foreground-muted py-12">
            No posts yet. Check back soon!
          </p>
        )}
      </div>
    </div>
  );
}
`;
}

function generateSampleBlogPost() {
  return `---
title: "Welcome to My Blog"
description: "First post on this new blog - exploring MDX, Next.js 15, and modern web development"
date: "2025-01-06"
author: "Your Name"
tags: ["nextjs", "mdx", "webdev"]
published: true
---

# Welcome to My Blog

This is a sample blog post written in MDX. MDX allows you to use JSX components inside markdown, making it incredibly powerful for creating rich, interactive content.

## What is MDX?

MDX is a format that combines Markdown with JSX. You can write standard Markdown:

- Lists
- **Bold text**
- *Italic text*
- [Links](https://example.com)

### Code Blocks

\`\`\`typescript
// TypeScript code with syntax highlighting
function greet(name: string): string {
  return \`Hello, \${name}!\`;
}

console.log(greet("World"));
\`\`\`

### Features of This Blog System

This blog system includes:

1. **MDX Support** - Write posts in MDX format
2. **Gray Matter** - Parse frontmatter for metadata
3. **Syntax Highlighting** - Code blocks with \`rehype-highlight\`
4. **GitHub Flavored Markdown** - Tables, task lists, and more with \`remark-gfm\`
5. **Reading Time** - Automatic calculation of reading time
6. **Tags & Categories** - Organize posts by tags
7. **SEO Optimized** - Proper metadata and Open Graph tags

## Next Steps

Edit this post in \`content/posts/welcome.mdx\` and create more posts!

---

Built with Next.js 15, MDX, and modern web technologies.
`;
}

function generatePackageJSON() {
  return `{
  "name": "mdx-blog-dependencies",
  "description": "Required packages for MDX blog system",
  "dependencies": {
    "next-mdx-remote": "^5.0.0",
    "gray-matter": "^4.0.3",
    "remark-gfm": "^4.0.0",
    "rehype-highlight": "^7.0.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0"
  }
}
`;
}

// ============================================================================
// TASK EXECUTION
// ============================================================================

async function executeContentTask(taskId) {
  const startTime = Date.now();

  console.log(`\n[Content MDX Agent] Executing task: ${taskId}`);

  // Update task status to in_progress
  await mcpRequest('updateAgentTask', {
    task_id: taskId,
    status: 'in_progress',
  });

  try {
    // Generate MDX system files
    console.log('[Content MDX Agent] Generating MDX blog system...');

    const mdxUtilities = generateMDXUtilities();
    const blogPostPage = generateBlogPostPage();
    const blogListingPage = generateBlogListingPage();
    const samplePost = generateSampleBlogPost();
    const packageJSON = generatePackageJSON();

    const output = {
      files_to_create: {
        'lib/mdx.ts': mdxUtilities,
        'app/blog/page.tsx': blogListingPage,
        'app/blog/[slug]/page.tsx': blogPostPage,
        'content/posts/welcome.mdx': samplePost,
        'mdx-packages.json': packageJSON,
      },
      setup_instructions: [
        '1. Install dependencies: npm install next-mdx-remote gray-matter remark-gfm rehype-highlight',
        '2. Create content/posts/ directory',
        '3. Add MDX files to content/posts/',
        '4. Import lib/mdx utilities in your blog pages',
        '5. Add highlight.js CSS theme to globals.css: @import "highlight.js/styles/github-dark.css";',
      ],
      features: [
        'MDX parsing with next-mdx-remote',
        'Frontmatter extraction with gray-matter',
        'GitHub Flavored Markdown (tables, task lists)',
        'Syntax highlighting for code blocks',
        'Reading time calculation',
        'Tag-based filtering',
        'SEO metadata generation',
        'Static generation with generateStaticParams',
      ],
    };

    const executionTime = Date.now() - startTime;

    // Update task as completed
    await mcpRequest('updateAgentTask', {
      task_id: taskId,
      status: 'completed',
      output,
      files_created: Object.keys(output.files_to_create),
      actual_duration_minutes: Math.ceil(executionTime / 1000 / 60),
    });

    // Log analytics
    await logAnalytics('mdx_blog_created', {
      files_count: Object.keys(output.files_to_create).length,
      features_count: output.features.length,
    }, null, executionTime);

    console.log(`[Content MDX Agent] ✓ Task completed (${executionTime}ms)`);
    console.log(`[Content MDX Agent] Generated ${Object.keys(output.files_to_create).length} files`);
    console.log(`[Content MDX Agent] Implemented ${output.features.length} features`);

    return output;

  } catch (error) {
    // Update task as failed
    await mcpRequest('updateAgentTask', {
      task_id: taskId,
      status: 'failed',
      error_message: error.message,
    });

    throw error;
  }
}

async function setupBlogForProject(projectId) {
  const startTime = Date.now();

  console.log(`\n[Content MDX Agent] Setting up blog for project: ${projectId}`);

  const mdxUtilities = generateMDXUtilities();
  const blogPostPage = generateBlogPostPage();
  const blogListingPage = generateBlogListingPage();
  const samplePost = generateSampleBlogPost();

  const executionTime = Date.now() - startTime;
  await logAnalytics('blog_system_setup', {
    files_count: 4,
  }, projectId, executionTime);

  console.log('[Content MDX Agent] ✓ Blog system generated');

  return {
    mdx_utilities: mdxUtilities,
    blog_post_page: blogPostPage,
    blog_listing_page: blogListingPage,
    sample_post: samplePost,
  };
}

// ============================================================================
// CLI
// ============================================================================

async function main() {
  const args = process.argv.slice(2);

  if (args.includes('--help') || args.includes('-h')) {
    console.log(`
Content MDX Agent - Blog & Content System Builder

Usage:
  node content-mdx-agent.js --task-id <uuid> --execute
  node content-mdx-agent.js --project-id <uuid> --setup-blog

Options:
  --task-id       Task ID to execute
  --execute       Execute the content task
  --project-id    Project ID to set up blog for
  --setup-blog    Set up blog system for project

Examples:
  # Execute assigned task
  node content-mdx-agent.js --task-id abc-123 --execute

  # Set up blog for project
  node content-mdx-agent.js --project-id xyz-789 --setup-blog

Environment Variables:
  MCP_URL         MCP API endpoint
  MCP_API_KEY     API key for authentication
    `);
    return;
  }

  try {
    const taskId = args.find((arg, i) => args[i - 1] === '--task-id');
    const execute = args.includes('--execute');
    const projectId = args.find((arg, i) => args[i - 1] === '--project-id');
    const setupBlog = args.includes('--setup-blog');

    if (taskId && execute) {
      await executeContentTask(taskId);
    } else if (projectId && setupBlog) {
      const result = await setupBlogForProject(projectId);
      console.log('\n[Content MDX Agent] Blog system created:');
      console.log('Files ready to be written to project');
    } else {
      console.error('Error: --task-id --execute or --project-id --setup-blog required');
      console.log('Use --help for usage information');
      process.exit(1);
    }

  } catch (error) {
    console.error('[Content MDX Agent] Fatal error:', error.message);
    await logAnalytics('content_system_error', {
      error_type: error.name,
      error_message: error.message,
    }, null, null);
    process.exit(1);
  }
}

if (require.main === module) {
  main();
}

module.exports = {
  generateMDXUtilities,
  generateBlogPostPage,
  generateBlogListingPage,
  generateSampleBlogPost,
  executeContentTask,
  setupBlogForProject,
  mcpRequest,
  logAnalytics,
};
