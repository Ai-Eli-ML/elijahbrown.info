#!/usr/bin/env node

/**
 * Design System Agent - Theme & Component Designer
 *
 * Responsibilities:
 * - Create comprehensive design systems (colors, typography, spacing)
 * - Generate CSS variables and theme configurations
 * - Build glass-morphism components and styles
 * - Query component library for reusable glass/UI components
 * - Create Tailwind config with custom theme
 * - Design responsive layouts and grid systems
 * - Generate shadcn/ui compatible components
 *
 * Usage:
 *   node design-system-agent.js --task-id <uuid> --execute
 *   node design-system-agent.js --project-id <uuid> --theme "dark-glass"
 */

const BASE_URL = process.env.MCP_URL || 'https://dashboard.advancingtechnology.online/api/mcp';
const API_KEY = process.env.MCP_API_KEY || 'pd_HRLYeHmVbBoO0Q6gS7a9Q37s2jMle88y';

// ============================================================================
// MCP API HELPERS
// ============================================================================

async function mcpRequest(method, params = {}) {
  const requestId = `design-${Date.now()}-${Math.random().toString(36).substring(7)}`;

  try {
    const response = await fetch(BASE_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_KEY}`,
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id: requestId,
        method,
        params,
      }),
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    if (data.error) {
      throw new Error(`MCP Error: ${data.error.message || JSON.stringify(data.error)}`);
    }

    return data.result || data;
  } catch (error) {
    console.error(`[Design System Agent] MCP Request Failed (${method}):`, error.message);
    throw error;
  }
}

async function logAnalytics(eventType, eventData, projectId = null, executionTimeMs = null) {
  try {
    await mcpRequest('logBuilderAnalytics', {
      website_project_id: projectId,
      event_type: eventType,
      event_category: 'agent',
      event_data: eventData,
      agent_name: 'design-system',
      agent_execution_time_ms: executionTimeMs,
    });
  } catch (error) {
    console.error('[Design System Agent] Analytics logging failed:', error.message);
  }
}

// ============================================================================
// DESIGN SYSTEM GENERATION
// ============================================================================

function generateColorPalette(theme = 'dark-glass') {
  const palettes = {
    'dark-glass': {
      background: {
        primary: 'hsl(240, 10%, 3.9%)',
        secondary: 'hsl(240, 5%, 6%)',
        tertiary: 'hsl(240, 4%, 10%)',
      },
      foreground: {
        primary: 'hsl(0, 0%, 98%)',
        secondary: 'hsl(0, 0%, 80%)',
        muted: 'hsl(0, 0%, 60%)',
      },
      accent: {
        primary: 'hsl(270, 70%, 60%)',
        secondary: 'hsl(200, 70%, 50%)',
        tertiary: 'hsl(320, 70%, 55%)',
      },
      glass: {
        background: 'rgba(255, 255, 255, 0.05)',
        border: 'rgba(255, 255, 255, 0.1)',
        glow: 'rgba(168, 85, 247, 0.3)',
      },
    },
    'light-modern': {
      background: {
        primary: 'hsl(0, 0%, 100%)',
        secondary: 'hsl(0, 0%, 98%)',
        tertiary: 'hsl(0, 0%, 96%)',
      },
      foreground: {
        primary: 'hsl(0, 0%, 3%)',
        secondary: 'hsl(0, 0%, 20%)',
        muted: 'hsl(0, 0%, 45%)',
      },
      accent: {
        primary: 'hsl(221, 83%, 53%)',
        secondary: 'hsl(142, 76%, 36%)',
        tertiary: 'hsl(346, 77%, 50%)',
      },
      glass: {
        background: 'rgba(0, 0, 0, 0.03)',
        border: 'rgba(0, 0, 0, 0.06)',
        glow: 'rgba(59, 130, 246, 0.2)',
      },
    },
    'neon-cyber': {
      background: {
        primary: 'hsl(270, 50%, 5%)',
        secondary: 'hsl(270, 40%, 8%)',
        tertiary: 'hsl(270, 35%, 12%)',
      },
      foreground: {
        primary: 'hsl(180, 100%, 95%)',
        secondary: 'hsl(180, 80%, 80%)',
        muted: 'hsl(180, 60%, 60%)',
      },
      accent: {
        primary: 'hsl(320, 100%, 50%)',
        secondary: 'hsl(180, 100%, 50%)',
        tertiary: 'hsl(280, 100%, 60%)',
      },
      glass: {
        background: 'rgba(255, 0, 255, 0.05)',
        border: 'rgba(0, 255, 255, 0.2)',
        glow: 'rgba(255, 0, 255, 0.5)',
      },
    },
  };

  return palettes[theme] || palettes['dark-glass'];
}

function generateCSSVariables(palette) {
  return `/* Generated by Design System Agent */

:root {
  /* Background Colors */
  --background-primary: ${palette.background.primary};
  --background-secondary: ${palette.background.secondary};
  --background-tertiary: ${palette.background.tertiary};

  /* Foreground Colors */
  --foreground-primary: ${palette.foreground.primary};
  --foreground-secondary: ${palette.foreground.secondary};
  --foreground-muted: ${palette.foreground.muted};

  /* Accent Colors */
  --accent-primary: ${palette.accent.primary};
  --accent-secondary: ${palette.accent.secondary};
  --accent-tertiary: ${palette.accent.tertiary};

  /* Glass Morphism */
  --glass-bg: ${palette.glass.background};
  --glass-border: ${palette.glass.border};
  --glass-glow: ${palette.glass.glow};

  /* Spacing Scale (8px base) */
  --space-1: 0.5rem;  /* 8px */
  --space-2: 1rem;    /* 16px */
  --space-3: 1.5rem;  /* 24px */
  --space-4: 2rem;    /* 32px */
  --space-5: 2.5rem;  /* 40px */
  --space-6: 3rem;    /* 48px */
  --space-8: 4rem;    /* 64px */
  --space-10: 5rem;   /* 80px */
  --space-12: 6rem;   /* 96px */
  --space-16: 8rem;   /* 128px */

  /* Typography Scale */
  --font-size-xs: 0.75rem;    /* 12px */
  --font-size-sm: 0.875rem;   /* 14px */
  --font-size-base: 1rem;     /* 16px */
  --font-size-lg: 1.125rem;   /* 18px */
  --font-size-xl: 1.25rem;    /* 20px */
  --font-size-2xl: 1.5rem;    /* 24px */
  --font-size-3xl: 1.875rem;  /* 30px */
  --font-size-4xl: 2.25rem;   /* 36px */
  --font-size-5xl: 3rem;      /* 48px */
  --font-size-6xl: 3.75rem;   /* 60px */

  /* Font Weights */
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;

  /* Border Radius */
  --radius-sm: 0.375rem;  /* 6px */
  --radius-md: 0.5rem;    /* 8px */
  --radius-lg: 0.75rem;   /* 12px */
  --radius-xl: 1rem;      /* 16px */
  --radius-2xl: 1.5rem;   /* 24px */
  --radius-full: 9999px;

  /* Shadows */
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
  --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
  --shadow-glow: 0 0 20px var(--glass-glow);

  /* Transitions */
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
}

/* Glass Morphism Utilities */
.glass {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.glass-glow {
  box-shadow: 0 0 20px var(--glass-glow);
}

.glass-reflection {
  position: relative;
  overflow: hidden;
}

.glass-reflection::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 50%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.1),
    transparent
  );
  transition: left var(--transition-base);
}

.glass-reflection:hover::before {
  left: 100%;
}
`;
}

function generateGlassComponents() {
  return `/* Glass Morphism Components - Generated by Design System Agent */

/* Glass Card */
.glass-card {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-xl);
  padding: var(--space-6);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  transition: all var(--transition-base);
}

.glass-card:hover {
  background: rgba(255, 255, 255, 0.08);
  box-shadow: var(--shadow-glow);
  transform: translateY(-2px);
}

/* Glass Button */
.glass-button {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  padding: var(--space-2) var(--space-4);
  color: var(--foreground-primary);
  font-weight: var(--font-weight-medium);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  transition: all var(--transition-fast);
  cursor: pointer;
}

.glass-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--accent-primary);
  box-shadow: 0 0 15px var(--glass-glow);
}

.glass-button:active {
  transform: scale(0.98);
}

/* Glass Input */
.glass-input {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  padding: var(--space-2) var(--space-3);
  color: var(--foreground-primary);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  transition: all var(--transition-fast);
  width: 100%;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px var(--glass-glow);
}

.glass-input::placeholder {
  color: var(--foreground-muted);
}

/* Glass Panel */
.glass-panel {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-2xl);
  padding: var(--space-8);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}

/* Glass Nav */
.glass-nav {
  background: var(--glass-bg);
  border-bottom: 1px solid var(--glass-border);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  position: sticky;
  top: 0;
  z-index: 50;
}

/* Frosted Overlay */
.frosted-overlay {
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
`;
}

function generateTailwindConfig(palette) {
  return `// Generated by Design System Agent
import type { Config } from "tailwindcss";

const config: Config = {
  darkMode: ["class"],
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      colors: {
        background: {
          primary: "${palette.background.primary}",
          secondary: "${palette.background.secondary}",
          tertiary: "${palette.background.tertiary}",
        },
        foreground: {
          primary: "${palette.foreground.primary}",
          secondary: "${palette.foreground.secondary}",
          muted: "${palette.foreground.muted}",
        },
        accent: {
          primary: "${palette.accent.primary}",
          secondary: "${palette.accent.secondary}",
          tertiary: "${palette.accent.tertiary}",
        },
        glass: {
          bg: "${palette.glass.background}",
          border: "${palette.glass.border}",
          glow: "${palette.glass.glow}",
        },
      },
      spacing: {
        '18': '4.5rem',
        '88': '22rem',
        '112': '28rem',
        '128': '32rem',
      },
      borderRadius: {
        '4xl': '2rem',
      },
      backdropBlur: {
        xs: '2px',
      },
    },
  },
  plugins: [],
};

export default config;
`;
}

// ============================================================================
// COMPONENT LIBRARY QUERIES
// ============================================================================

async function queryGlassComponents() {
  console.log('[Design System Agent] Querying component library for glass-morphism components...');

  const result = await mcpRequest('getReusableComponents', {
    category: 'ui',
    subcategory: 'glass-morphism',
    limit: 10,
  });

  const components = result.components || [];
  console.log(`[Design System Agent] Found ${components.length} glass-morphism components`);

  return components;
}

async function query3DComponents() {
  console.log('[Design System Agent] Querying component library for 3D effect components...');

  const result = await mcpRequest('getReusableComponents', {
    category: 'effects',
    subcategory: 'threejs',
    limit: 10,
  });

  const components = result.components || [];
  console.log(`[Design System Agent] Found ${components.length} 3D components`);

  return components;
}

// ============================================================================
// TASK EXECUTION
// ============================================================================

async function executeDesignTask(taskId, theme = 'dark-glass') {
  const startTime = Date.now();

  console.log(`\n[Design System Agent] Executing task: ${taskId}`);

  // Update task status to in_progress
  await mcpRequest('updateAgentTask', {
    task_id: taskId,
    status: 'in_progress',
  });

  try {
    // Generate design system
    console.log(`[Design System Agent] Generating ${theme} design system...`);
    const palette = generateColorPalette(theme);
    const cssVariables = generateCSSVariables(palette);
    const glassComponents = generateGlassComponents();
    const tailwindConfig = generateTailwindConfig(palette);

    // Query component library
    const glassComps = await queryGlassComponents();
    const threeComps = await query3DComponents();

    // Prepare output
    const output = {
      theme,
      palette,
      files_to_create: {
        'src/styles/variables.css': cssVariables,
        'src/styles/glass.css': glassComponents,
        'tailwind.config.ts': tailwindConfig,
      },
      component_library: {
        glass_components: glassComps.map(c => c.name),
        threejs_components: threeComps.map(c => c.name),
      },
      recommendations: [
        'Import variables.css in globals.css',
        'Import glass.css for glass-morphism utilities',
        'Use GlassCard component from library for consistent styling',
        'Consider adding framer-motion for glass component animations',
      ],
    };

    const executionTime = Date.now() - startTime;

    // Update task as completed
    await mcpRequest('updateAgentTask', {
      task_id: taskId,
      status: 'completed',
      output,
      files_created: Object.keys(output.files_to_create),
      actual_duration_minutes: Math.ceil(executionTime / 1000 / 60),
    });

    // Log analytics
    await logAnalytics('design_system_created', {
      theme,
      files_count: Object.keys(output.files_to_create).length,
      components_found: glassComps.length + threeComps.length,
    }, null, executionTime);

    console.log(`[Design System Agent] âœ“ Task completed (${executionTime}ms)`);
    console.log(`[Design System Agent] Generated ${Object.keys(output.files_to_create).length} files`);
    console.log(`[Design System Agent] Found ${glassComps.length + threeComps.length} reusable components`);

    return output;

  } catch (error) {
    // Update task as failed
    await mcpRequest('updateAgentTask', {
      task_id: taskId,
      status: 'failed',
      error_message: error.message,
    });

    throw error;
  }
}

async function createDesignForProject(projectId, theme = 'dark-glass') {
  const startTime = Date.now();

  console.log(`\n[Design System Agent] Creating design system for project: ${projectId}`);

  const palette = generateColorPalette(theme);
  const cssVariables = generateCSSVariables(palette);
  const glassComponents = generateGlassComponents();
  const tailwindConfig = generateTailwindConfig(palette);

  const glassComps = await queryGlassComponents();

  const executionTime = Date.now() - startTime;
  await logAnalytics('design_system_generated', {
    theme,
    files_count: 3,
  }, projectId, executionTime);

  return {
    palette,
    css_variables: cssVariables,
    glass_components: glassComponents,
    tailwind_config: tailwindConfig,
    library_components: glassComps,
  };
}

// ============================================================================
// CLI
// ============================================================================

async function main() {
  const args = process.argv.slice(2);

  if (args.includes('--help') || args.includes('-h')) {
    console.log(`
Design System Agent - Theme & Component Designer

Usage:
  node design-system-agent.js --task-id <uuid> --execute
  node design-system-agent.js --project-id <uuid> --theme "dark-glass"

Options:
  --task-id       Task ID to execute
  --execute       Execute the design task
  --project-id    Project ID to create design for
  --theme         Theme name: dark-glass|light-modern|neon-cyber (default: dark-glass)

Examples:
  # Execute assigned task
  node design-system-agent.js --task-id abc-123 --execute

  # Create design system for project
  node design-system-agent.js --project-id xyz-789 --theme neon-cyber

  # Query component library
  node design-system-agent.js --query-components

Environment Variables:
  MCP_URL         MCP API endpoint
  MCP_API_KEY     API key for authentication
    `);
    return;
  }

  try {
    const taskId = args.find((arg, i) => args[i - 1] === '--task-id');
    const execute = args.includes('--execute');
    const projectId = args.find((arg, i) => args[i - 1] === '--project-id');
    const theme = args.find((arg, i) => args[i - 1] === '--theme') || 'dark-glass';
    const queryComponents = args.includes('--query-components');

    if (queryComponents) {
      await queryGlassComponents();
      await query3DComponents();
    } else if (taskId && execute) {
      await executeDesignTask(taskId, theme);
    } else if (projectId) {
      const result = await createDesignForProject(projectId, theme);
      console.log('\n[Design System Agent] Design system created:');
      console.log(JSON.stringify(result, null, 2));
    } else {
      console.error('Error: --task-id --execute or --project-id required');
      console.log('Use --help for usage information');
      process.exit(1);
    }

  } catch (error) {
    console.error('[Design System Agent] Fatal error:', error.message);
    await logAnalytics('design_system_error', {
      error_type: error.name,
      error_message: error.message,
    }, null, null);
    process.exit(1);
  }
}

if (require.main === module) {
  main();
}

module.exports = {
  generateColorPalette,
  generateCSSVariables,
  generateGlassComponents,
  generateTailwindConfig,
  queryGlassComponents,
  executeDesignTask,
  createDesignForProject,
  mcpRequest,
  logAnalytics,
};
